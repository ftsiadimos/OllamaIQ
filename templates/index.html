{% extends "base.html" %}

{% block title %}Ollama IQ Test{% endblock %}

{% block page_title %}Ollama IQ Test{% endblock %}
{% block page_subtitle %}Benchmark your local LLM models{% endblock %}

{% block content %}
  <div id="global-alert" class="alert" style="display:none;" role="alert" aria-live="assertive"></div>
  <script>
    (function(){
      function hideAlert(){ var el = document.getElementById('global-alert'); if(!el) return; el.style.display='none'; el.innerHTML=''; el.classList.remove('alert-error','alert-info'); }
      function showError(msg){ var el = document.getElementById('global-alert'); if(!el) return; el.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">' + '<div><strong>Error:</strong> ' + String(msg) + '</div>' + '<button class="chart-modal-close" onclick="hideAlert()" aria-label="close">‚úï</button>' + '</div>'; el.classList.add('alert-error'); el.style.display='block'; window.scrollTo({top:0,behavior:"smooth"}); }
      window.showError = showError;
      window.hideAlert = hideAlert;
    })();
  </script>

  <div class="grid">
    <section class="panel controls">
      <div class="panel-header">
        <h3>Connection</h3>
        <span class="panel-hint">Choose a host and fetch models</span>
      </div>
      <form id="fetchForm" action="/fetch" method="post" class="stack">
        <label>
          Saved hosts
          <div class="host-select-wrapper">
            <select name="host" id="hostSelect">
              {% set host_list = saved_hosts %}
              {% set current_host = results.host if results else '' %}
              {% for h in host_list %}
                <option value="{{ h }}" {% if h == current_host %}selected{% endif %}>{{ h }}</option>
              {% endfor %}
            </select>
            <button type="button" class="host-delete-btn" id="deleteHostBtn" title="Delete selected host" aria-label="Delete selected host">üóëÔ∏è</button>
          </div>
        </label>
        <script>
          (function(){
            var deleteBtn = document.getElementById('deleteHostBtn');
            var hostSelect = document.getElementById('hostSelect');
            if (deleteBtn && hostSelect) {
              deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                var host = hostSelect.value;
                if (!host) return;
                if (!confirm('Delete saved host "' + host + '"?')) return;
                fetch('/delete_host', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({host: host})
                }).then(function(r){ return r.json(); }).then(function(data){
                  if (data.success) {
                    // Remove from select
                    var opt = hostSelect.querySelector('option[value="' + CSS.escape(host) + '"]');
                    if (opt) opt.remove();
                    // Select first remaining or clear
                    if (hostSelect.options.length > 0) hostSelect.selectedIndex = 0;
                  } else if (data.error) {
                    if (window.showError) window.showError(data.error);
                  }
                }).catch(function(err){
                  if (window.showError) window.showError('Failed to delete host: ' + err);
                });
              });
            }
          })();
        </script>
        <label>
          Or enter new host
          <input type="text" name="host_new" value="" placeholder="http://localhost:11434" autocomplete="url">
        </label>
        <label>
          API key (optional)
          <input type="password" name="api_key" autocomplete="current-password" placeholder="sk-...">
        </label>
        <label>
          Repeat per prompt
          <input type="number" name="repeat" value="1" min="1" step="1">
        </label>
        <div class="form-actions">
          <button type="submit">Fetch models</button>
          <button type="button" class="secondary" onclick="document.getElementById('hostSelect').value='http://localhost:11434'">Reset</button>
        </div>
      </form>

      <div id="models-container" class="stack-lg">
        <!-- models checkbox block (rendered when available) -->
        {% if results and results.available_models and (rows is not defined or rows|length == 0) %}
          {% import '_models_block.html' as mb %}
          {{ mb.models_block(results.available_models, results.host) }}
        {% endif %}
      </div>
    </section>

    <section class="panel results-panel">
      <div class="panel-header">
        <h3>Live Progress</h3>
        <span class="panel-hint">Run logs and charts render here</span>
      </div>
      <div id="progress-area"></div>
      <div id="results-area">
        {% if results and results.models_tested and results.models_tested|length > 0 %}
          <!-- Viewing saved run from history -->
          <h3>Results</h3>
          {% set top = results.top_summary %}
          {% if top %}
          <div class="summary-card" style="margin-bottom:8px;padding:8px">
            {% if top.fastest %}
            <div><strong>Fastest:</strong> {{ top.fastest.model }} ({{ top.fastest.mean }}s)</div>
            {% endif %}
            {% if top.best_code %}
            <div><strong>Best code:</strong> {{ top.best_code.model }} ({{ top.best_code.code_score or 'N/A' }}%)</div>
            {% endif %}
            {% if top.best_smart %}
            <div><strong>Best smartness:</strong> {{ top.best_smart.model }} ({{ top.best_smart.smartness_score or 'N/A' }}%)</div>
            {% endif %}
          </div>
          {% endif %}
          <div class="table-responsive">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Model</th>
                  <th class="numeric">Smartness</th>
                  <th class="numeric">Code</th>
                  <th class="numeric">Mean</th>
                  <th class="numeric">Median</th>
                  <th class="numeric">Min</th>
                  <th class="numeric">Max</th>
                </tr>
              </thead>
              <tbody>
                {% for m in results.models_tested %}
                <tr>
                  <td>{{ m.model }}</td>
                  <td>{{ m.smartness_score }}%</td>
                  <td>{{ m.code_score if m.code_score is not none else 'N/A' }}{% if m.code_score is not none %}%{% endif %}</td>
                  <td>{{ m.latency_stats.mean if m.latency_stats else '' }}</td>
                  <td>{{ m.latency_stats.median if m.latency_stats else '' }}</td>
                  <td>{{ m.latency_stats.min if m.latency_stats else '' }}</td>
                  <td>{{ m.latency_stats.max if m.latency_stats else '' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="chart-grid">
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">Mean Latency</span>
                <button type="button" class="chart-fullscreen-btn" data-chart="latencyChart" title="View fullscreen">‚õ∂</button>
              </div>
              <canvas id="latencyChart"></canvas>
            </div>
            <div class="chart-container">
              <div class="chart-header">
                <span class="chart-title">Code vs Smartness</span>
                <button type="button" class="chart-fullscreen-btn" data-chart="radarChart" title="View fullscreen">‚õ∂</button>
              </div>
              <canvas id="radarChart"></canvas>
            </div>
          </div>
          <script>
            (function(){
              var savedResults = {{ results | tojson | safe }};
              
              // Store chart data globally for fullscreen
              var chartData = window.chartData || {};
              
              var models = (savedResults.models_tested||[]).map(function(m){ return m.model; });
              var means = (savedResults.models_tested||[]).map(function(m){ return (m.latency_stats||{}).mean || 0; });
              
              chartData.latencyChart = {
                type: 'bar',
                data: {labels: models, datasets: [{label:'Mean latency (s)', data: means, backgroundColor:'rgba(124,58,237,0.6)'}]},
                options: {responsive: true, maintainAspectRatio: false}
              };
              chartData.radarChart = {
                type: 'radar',
                data: {
                  labels: models,
                  datasets: [
                    {label:'Code %', data:(savedResults.models_tested||[]).map(function(m){ return (m.code_score === null || m.code_score === undefined) ? 0 : m.code_score }), backgroundColor:'rgba(6,182,212,0.15)', borderColor:'rgba(6,182,212,0.6)'},
                    {label:'Smartness %', data:(savedResults.models_tested||[]).map(function(m){ return m.smartness_score||0 }), backgroundColor:'rgba(124,58,237,0.15)', borderColor:'rgba(124,58,237,0.9)'}
                  ]
                },
                options: {responsive: true, maintainAspectRatio: false}
              };
              
              window.chartData = chartData;
              
              var ctx = document.getElementById('latencyChart');
              if (ctx && models.length) {
                try { new Chart(ctx.getContext('2d'), chartData.latencyChart); } catch(e) { console.warn(e); }
              }
              var ctx2 = document.getElementById('radarChart');
              if (ctx2 && models.length) {
                try { new Chart(ctx2.getContext('2d'), chartData.radarChart); } catch(e) { console.warn(e); }
              }
              
              // Fullscreen handlers
              function openChartFullscreen(chartId) {
                var modal = document.getElementById('chart-fullscreen-modal');
                if (!modal) {
                  modal = document.createElement('div');
                  modal.id = 'chart-fullscreen-modal';
                  modal.className = 'chart-modal';
                  modal.innerHTML = '<div class="chart-modal-content"><div class="chart-modal-header"><span class="chart-modal-title"></span><button type="button" class="chart-modal-close" title="Close">‚úï</button></div><div class="chart-modal-body"><canvas id="fullscreenChart"></canvas></div></div>';
                  document.body.appendChild(modal);
                  
                  modal.querySelector('.chart-modal-close').addEventListener('click', closeChartFullscreen);
                  modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeChartFullscreen();
                  });
                  document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') closeChartFullscreen();
                  });
                }
                
                var title = chartId === 'latencyChart' ? 'Mean Latency' : 'Code vs Smartness';
                modal.querySelector('.chart-modal-title').textContent = title;
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                setTimeout(function() {
                  var ctx = document.getElementById('fullscreenChart');
                  if (ctx && chartData[chartId]) {
                    if (window.fullscreenChartInstance) {
                      window.fullscreenChartInstance.destroy();
                    }
                    window.fullscreenChartInstance = new Chart(ctx.getContext('2d'), JSON.parse(JSON.stringify(chartData[chartId])));
                  }
                }, 100);
              }
              
              function closeChartFullscreen() {
                var modal = document.getElementById('chart-fullscreen-modal');
                if (modal) {
                  modal.classList.remove('active');
                  document.body.style.overflow = '';
                  if (window.fullscreenChartInstance) {
                    window.fullscreenChartInstance.destroy();
                    window.fullscreenChartInstance = null;
                  }
                }
              }
              
              document.querySelectorAll('.chart-fullscreen-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  var chartId = btn.getAttribute('data-chart');
                  openChartFullscreen(chartId);
                });
              });
            })();
          </script>
        {% endif %}
      </div>
    </section>
  </div>

  {% if results %}
    {% if results.error %}
      <div class="alert-error">
        <strong>Error connecting to Ollama:</strong>
        <div>{{ results.error }}</div>
        <p><strong>Troubleshooting steps:</strong></p>
        <ol>
          <li>Ensure Ollama is installed: <code>which ollama</code> or see <a href="https://ollama.com/download">https://ollama.com/download</a></li>
          <li>If installed, start a model (which will start the local service): e.g. <code>ollama pull gemma3</code> then <code>ollama run gemma3</code></li>
          <li>Check the server is listening: <code>curl -v {{ results.host }}</code> or <code>ss -ltnp | grep 11434</code></li>
          <li>If using a remote host, verify the host URL and any API key are correct and reachable</li>
        </ol>
      </div>
    {% elif rows|length == 0 %}
      <!-- No models tested; model list is shown in the left panel. -->
    {% else %}
      <div class="summary summary-cards">
        {% if fastest %}
          <div class="summary-card">
            <div class="small">Fastest</div>
            <div class="summary-title">{{ fastest.model }}</div>
            <div class="small">mean {{ fastest.mean }}s</div>
          </div>
        {% endif %}
        {% if best_code %}
          <div class="summary-card">
            <div class="small">Best code</div>
            <div class="summary-title">{{ best_code.model }}</div>
            <div class="small">{{ best_code.code }}%</div>
          </div>
        {% endif %}
        {% if best_smart %}
          <div class="summary-card">
            <div class="small">Best smartness</div>
            <div class="summary-title">{{ best_smart.model }}</div>
            <div class="small">{{ best_smart.smartness }}%</div>
          </div>
        {% endif %}
      </div>

      <div class="table-responsive">
        <table class="results-table">
          <thead>
            <tr>
              <th>Model</th>
              <th class="numeric">Smartness</th>
              <th class="numeric">Code</th>
              <th class="numeric">Mean</th>
              <th class="numeric">Median</th>
              <th class="numeric">Min</th>
              <th class="numeric">Max</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.model }}</td>
            <td>{{ r.smartness }}</td>
            <td>{{ r.code }}</td>
            <td>{{ r.mean }}</td>
            <td>{{ r.median }}</td>
            <td>{{ r.min }}</td>
            <td>{{ r.max }}</td>
            <td><details><summary>show</summary>
              <pre>{% for t in r.tests %}{% for p in t.passes %}{{ t.name }}: latency={{ "%.4f"|format(p.latency_s) }}s
{{ p.response | e }}

{% endfor %}{% endfor %}</pre>
            </details></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
    {% endif %}
  {% endif %}

{% endblock %}